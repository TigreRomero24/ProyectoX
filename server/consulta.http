### ====================================================================
### 1. BLOQUE DE REGISTRO (Validación de Datos)
### ====================================================================

### 1.1 Registro EXITOSO (Estudiante)
# Esperado: 201 Created
POST http://localhost:3000/api/usuarios
Content-Type: application/json

{
    "correo_institucional": "test_user12@unemi.edu.ec",
    "password": "PasswordSeguro123!",
    "rol": "ESTUDIANTE"
}

### 1.2 Error: Dominio No Institucional
# Intento de registro con Gmail
# Esperado: 400 Bad Request
POST http://localhost:3000/api/usuarios
Content-Type: application/json

{
    "correo_institucional": "hacker@gmail.com",
    "password": "Password123!"
}

### 1.3 Error: Usuario Duplicado
# Intenta registrar el mismo correo del paso 1.1
# Esperado: 409 Conflict
POST http://localhost:3000/api/usuarios
Content-Type: application/json

{
    "correo_institucional": "test_user1@unemi.edu.ec",
    "password": "Password123!"
}

### 1.4 Error: Inyección de Rol (Intento de crear Admin)
# El backend debe ignorar "ADMIN" y crear "ESTUDIANTE"
# Esperado: 201 Created (pero como estudiante)
POST http://localhost:3000/api/usuarios
Content-Type: application/json

{
    "correo_institucional": "falso_admin2@unemi.edu.ec",
    "password": "Password123!",
    "rol": "ADMIN"
}

### ====================================================================
### 2. BLOQUE DE LOGIN Y SESIÓN (El Core de tu Seguridad)
### ====================================================================

### 2.1 Login EXITOSO - Primer Dispositivo (PC CASA)
# @name loginEstudiante
# NOTA: Captura automática del token para siguientes peticiones
# Esperado: 200 OK + accessToken
POST http://localhost:3000/api/login
Content-Type: application/json

{
    "correo_institucional": "test_user@unemi.edu.ec",
    "password": "PasswordSeguro123!",
    "huella_dispositivo": "HUELLA_PC_CASA_12345"
}

### VARIABLE AUTOMÁTICA (No tocar)
@authToken = {{loginEstudiante.response.body.accessToken}}

### 2.2 Login EXITOSO - Mismo Dispositivo (PC CASA)
# Simula al usuario volviendo a entrar desde el mismo PC
# Esperado: 200 OK
POST http://localhost:3000/api/login
Content-Type: application/json

{
    "correo_institucional": "test_user@unemi.edu.ec",
    "password": "PasswordSeguro123!",
    "huella_dispositivo": "HUELLA_PC_CASA_12345"
}

### 2.3 ERROR CRÍTICO: Robo de Credenciales (Dispositivo Diferente)
# Simula que un hacker tiene el usuario y password, pero entra desde otro PC
# Regla de Negocio #1
# Esperado: 403 Forbidden
POST http://localhost:3000/api/login
Content-Type: application/json

{
    "correo_institucional": "test_user@unemi.edu.ec",
    "password": "PasswordSeguro123!",
    "huella_dispositivo": "HUELLA_HACKER_MOVIL_999"
}

### 2.4 Error: Password Incorrecto
# Esperado: 401 Unauthorized
POST http://localhost:3000/api/login
Content-Type: application/json

{
    "correo_institucional": "test_user@unemi.edu.ec",
    "password": "PasswordMALO",
    "huella_dispositivo": "HUELLA_PC_CASA_12345"
}

### ====================================================================
### 3. BLOQUE DE RUTAS PROTEGIDAS (Middleware Test)
### ====================================================================

### 3.1 Acceso EXITOSO a Perfil
# Envía Token válido Y Huella correcta en headers
# Esperado: 200 OK
GET http://localhost:3000/api/usuarios
Authorization: Bearer {{authToken}}
X-Device-Fingerprint: HUELLA_PC_CASA_12345

### 3.2 ROBO DE SESIÓN (Token Hijacking)
# Tengo el Token (robado), pero mi huella es diferente
# Esperado: 403 Forbidden (Tu middleware debe bloquear esto)
GET http://localhost:3000/api/usuarios
Authorization: Bearer {{authToken}}
X-Device-Fingerprint: HUELLA_HACKER_MOVIL_999

### 3.3 Error: Token Manipulado/Falso
# Esperado: 401 Unauthorized
GET http://localhost:3000/api/usuarios
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.falso.token
X-Device-Fingerprint: HUELLA_PC_CASA_12345

### 3.4 Error: Falta Header de Huella
# Esperado: 400 Bad Request
GET http://localhost:3000/api/usuarios
Authorization: Bearer {{authToken}}
# (Sin header X-Device-Fingerprint)

### ====================================================================
### 4. CICLO DE VIDA DEL TOKEN (Refresh & Logout)
### ====================================================================

### 4.1 Refrescar Token (Cookie automática)
# Esperado: 200 OK + Nuevo Access Token
POST http://localhost:3000/api/refresh
Content-Type: application/json

### 4.2 Cerrar Sesión (Logout)
# Debe limpiar la cookie y la BD
# Esperado: 200 OK
POST http://localhost:3000/api/logout
Content-Type: application/json
Authorization: Bearer {{authToken}}

### 4.3 Verificar Logout
# Intentar usar el token viejo después de logout
# Esperado: 401 Unauthorized
GET http://localhost:3000/api/usuarios
Authorization: Bearer {{authToken}}
X-Device-Fingerprint: HUELLA_PC_CASA_12345